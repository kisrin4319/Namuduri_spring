<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">

<!-- //////////////////////////////////////////////////////////////////////////////////// -->

	<!-- 회원 정보 가져오기(리스트) -->
	<select id="memberListAll" resultType="MemberModel">
		SELECT * FROM MEMBER ORDER BY MEMBER_JOIN_DATE DESC
	</select>
	<!-- 활성화 회원 조회 -->
	<select id="memberListAct" resultType="MemberModel">
		SELECT * FROM MEMBER WHERE MEMBER_USE_YN = 0 ORDER BY MEMBER_JOIN_DATE DESC
	</select>
	<!-- 차단 회원 조회 -->
	<select id="memberListBck" resultType="MemberModel">
		SELECT * FROM MEMBER WHERE MEMBER_USE_YN = 1 ORDER BY MEMBER_JOIN_DATE DESC
	</select>
	
	<!-- 회원 검색 목록 -->
	<select id="searchMember" parameterType="map" resultType="MemberModel">
		SELECT * FROM MEMBER
		<where>
			<if test="searchNum!=0">
				<if test="searchNum == 1">AND MEMBER_ID like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 2">AND MEMBER_NAME like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 3">AND MEMBER_EMAIL like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 4">AND MEMBER_PHONE like '%'||#{searchKeyword}||'%' 
					AND MEMBER_MOBILE like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 5">AND MEMBER_JUMIN1 like '%'||#{searchKeyword}||'%'
					AND MEMBER_JUMIN2 like '%'||#{searchKeyword}||'%'</if>
			</if>
			<if test="active!=0">
					<if test="active==1">
						AND MEMBER_USE_YN = 0
					</if>
					<if test="active==2">
						AND MEMBER_USE_YN = 1
					</if>
			</if>
			<if test="date_min!=null"><![CDATA[AND MEMBER_JOIN_DATE >= #{date_min}]]></if>
			<if test="date_max!=null"><![CDATA[AND MEMBER_JOIN_DATE <= #{date_max}]]></if>
		</where>
		ORDER BY MEMBER_JOIN_DATE DESC
	</select>
	<!-- POST 전송 검색 폼 데이터로 검색 --><!-- 기간 조건 추가.. -->
	<!-- <select id="searchMember" resultType="MemberModel">
		SELECT * FROM MEMBER WHERE MEMBER_ID like '%'||#{member_id}||'%'
								AND MEMBER_NAME like '%'||#{member_name}||'%'
								AND MEMBER_JUMIN1 like '%'||#{member_jumin1}||'%'
								AND MEMBER_JUMIN2 like '%'||#{member_jumin1}||'%'
								AND MEMBER_PHONE like '%'||#{member_phone}||'%'
								AND MEMBER_MOBILE like '%'||#{member_phone}||'%'
								AND MEMBER_EMIAL like '%'||#{member_email}||'%'
		ORDER BY MEMBER_JOIN_DATE DESC
	</select> -->
	
	<!-- 회원 정보 조회 -->
	<select id="memberView" resultType="MemberModel">
		SELECT * FROM MEMBER WHERE MEMBER_ID = #{member_id}
	</select>
	
	<!-- 회원 정보 수정 -->
	<update id="memberModify" parameterType="MemberModel">
		UPDATE MEMBER SET MEMBER_PW = #{member_pw}, 
						MEMBER_NAME = #{member_name},
		    			MEMBER_JUMIN1 = #{member_jumin1}, 
	    				MEMBER_JUMIN2 = #{member_jumin2},
				    	MEMBER_EMAIL = #{member_email},
					   	MEMBER_EMAIL_GET = #{member_email_get, jdbcType=VARCHAR},
					   	MEMBER_PHONE = #{member_phone}, 
					    MEMBER_MOBILE = #{member_mobile},
					    MEMBER_ZIPCODE = #{member_zipcode}, 
					    MEMBER_ADDR1 = #{member_addr1},
					    MEMBER_ADDR2 = #{member_addr2}, 
					    MEMBER_BANKNAME = #{member_bankname},
					    MEMBER_REFUND_ACCOUNT = #{member_refund_account},
					    MEMBER_ACCOUNT_HOLDER = #{member_account_holder},
					    MEMBER_USE_YN = #{member_use_yn}  
		WHERE MEMBER_ID = #{member_id}
	</update>
	
	
<!-- //////////////////////////////////////////////////////////////////////////////////// -->

	<!-- 도서 정보 가져오기(리스트) -->
	<select id="bookListAll" resultType="BooksModel">
		SELECT * FROM BOOK ORDER BY BOOK_DATE DESC
	</select>
	<!-- 사용 도서 조회 -->
	<select id="bookListAct" resultType="BooksModel">
		SELECT * FROM MEMBER WHERE BOOK_USE_YN = 1 ORDER BY BOOK_DATE DESC
	</select>
	<!-- 비사용 도서 조회 -->
	<select id="bookListBck" resultType="BooksModel">
		SELECT * FROM MEMBER WHERE BOOK_USE_YN = 0 ORDER BY BOOK_DATE DESC
	</select>
	<!-- 관리자 도서 검색 목록 -->
	<select id="searchBook" parameterType="map" resultType="BooksModel">
		SELECT * FROM BOOK
		<where>
			<if test="searchNum!=0">
				<if test="searchNum == 1">AND BOOK_NAME like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 2">AND BOOK_CATEGORY like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 3">AND BOOK_AUTH like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 4">AND COMPANY_ID like '%'||#{searchKeyword}||'%'</if>
			</if>
			<if test="active!=0">
					<if test="active==1">
						AND BOOK_USE_YN = 1
					</if>
					<if test="active==2">
						AND BOOK_USE_YN = 0
					</if>
			</if>
			<if test="date_min!=null"><![CDATA[AND BOOK_DATE >= #{date_min}]]></if>
			<if test="date_max!=null"><![CDATA[AND BOOK_DATE <= #{date_max}]]></if>
		</where>
		ORDER BY BOOK_DATE DESC
	</select>
	
	<!-- <select id="searchBook" resultType="BooksModel">
		SELECT * FROM BOOK WHERE BOOK_NAME like '%'||#{book_name}||'%'
								AND BOOK_CATEGORY like '%'||#{book_category}||'%'
								AND BOOK_AUTH like '%'||#{book_auth}||'%'
								AND BOOK_COMPANY like '%'||#{book_company}||'%'
		ORDER BY BOOK_DATE DESC -->
		<!-- WHERE BOOK_DATE >= #{date_min} AND BOOK_DATE <= #{date_max} -->
		<!-- WHERE BOOK_USE_YN = 1 OR BOOK_USE_YN = 0 -->
	<!-- </select> -->
	
	<!-- 가장 최근의 도서 정보 조회 -->
	<select id="selectNewest" resultType="BooksModel">
		<!-- select rownum, a.* from (select * from book order by book_date desc) a where rownum=1 -->
		select BOOK_NUM, BOOK_CATEGORY, BOOK_NAME, BOOK_CONTENT, BOOK_PRICE, BOOK_IMAGE, BOOK_SELL_COUNT, BOOK_BASE_COUNT, 
			BOOK_CURRENT_COUNT, BOOK_PUBLISH_DATE, BOOK_DATE, COMPANY_ID, BOOK_AUTH, BOOK_USE_YN from 
				(select rownum, a.* from (select * from book order by book_date desc) a where rownum=1)
	</select>
	
	<!-- 단일 도서 정보 조회 -->
	<select id="selectOne" resultType="BooksModel">
		SELECT * FROM BOOK WHERE BOOK_NUM = #{BOOK_NUM}
	</select>
	
<!-- //////////////////////////////////////////////////////////////////////////////////// -->

	<!-- 전체 주문 리스트 가져오기 -->
 	<select id="orderListAll" resultType="OrderModel">
		SELECT * FROM ORDER_BOOK ORDER BY ORDER_REGDATE
	</select>
	<!-- 처리완료(배송까지 완료) 주문 -->
	<select id="orderListAct" resultType="OrderModel">
		SELECT * FROM ORDER_BOOK WHERE ORDER_USE_YN = 1 ORDER BY ORDER_REGDATE
	</select>
	<!-- 취소된 주문 -->
	<select id="orderListBck" resultType="OrderModel">
		SELECT * FROM ORDER_BOOK WHERE ORDER_USE_YN = 0 ORDER BY ORDER_REGDATE
	</select>

	<!-- 관리자 주문 검색 목록 -->
	<select id="searchOrder" parameterType="map" resultType="OrderModel">
		SELECT * FROM ORDER_BOOK
		<where>
			<if test="searchNum!=0">
				<if test="searchNum == 1">AND ORDER_TRADE_NUM like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 2">AND ORDER_TRANS_NUM like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 3">AND MEMBER_ID like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 4">AND ORDER_TRADE_PAYER like '%'||#{searchKeyword}||'%'</if>
				<if test="searchNum == 5">AND ORDER_RECEIVE_NAME like '%'||#{searchKeyword}||'%'</if>
			</if>
			<if test="pay_s!=0">
				<if test="pay_s == 1">AND PAYMENT_STATUS='PS01'</if>
				<if test="pay_s == 2">AND PAYMENT_STATUS='PS02'</if>
			</if>
			<if test="trans_s!=0">
				<if test="trans_s == 1">AND ORDER_TRANS_STATUS='ST01'</if>
				<if test="trans_s == 2">AND ORDER_TRANS_STATUS='ST02'</if>
				<if test="trans_s == 3">AND ORDER_TRANS_STATUS='ST03'</if>
			</if>
			<if test="active!=0">
				AND ORDER_USE_YN = 0
			</if>
			<if test="date_min!=null"><![CDATA[AND ORDER_REGDATE >= #{date_min}]]></if>
			<if test="date_max!=null"><![CDATA[AND ORDER_REGDATE <= #{date_max}]]></if>
		</where>
		ORDER BY ORDER_REGDATE DESC
	</select>
	<!-- <select id="searchOrder" resultType="OrderModel">
		SELECT * FROM BOOK WHERE ORDER_TRADE_NUM like '%'||#{order_trade_num}||'%'
								AND MEMBER_ID like '%'||#{member_id}||'%'
								AND ORDER_TRADE_PAYER like '%'||#{order_trade_payer}||'%'
								AND ORDER_TRANS_NUM like '%'||#{order_trans_num}||'%'
								AND ORDER_RECEIVE_NAME like '%'||#{order_receive_name}||'%'
								AND ORDER_RECEIVE_PHONE like '%'||#{order_receive_phone}||'%'
								AND ORDER_RECEIVE_MOBILE like '%'||#{order_receive_phone}||'%'
								AND PAYMENT_STATUS = #{payment_status}
								AND ORDER_TRANS_STATUS = #{order_trans_status}
		ORDER BY BOOK_DATE DESC
		WHERE BOOK_DATE >= #{date_min} AND BOOK_DATE <= #{date_max}
		WHERE BOOK_USE_YN = 1 OR BOOK_USE_YN = 0
	</select> -->
	
	<!-- //////////////////////////////////////////////////////////////////////////////////// -->
	<!-- chartM으로 종합 통계 구현하기. 아래의 주간 통계의 날짜를 지정 가능 하도록 해서 종합 통계 제공 -->
	
	<select id="chartAllM" resultType="ChartModel"> <!-- 날짜별 누적 회원수 -->
		<![CDATA[
		select trunc(member_join_date) key, sum(count(*)) OVER (ORDER BY trunc(member_join_date)) value 
		from member group by trunc(member_join_date)
		]]>
	</select>
	
	<select id="chartNewM"> <!-- 최근 일주일 동안 가입한 회원 수 통계 -->
		<![CDATA[
		select b.*, to_char(dayno,'day') day 
		from (
			select count(*) NewNo, trunc(member_join_date) DayNo 
			from member group by trunc(member_join_date) order by DayNo desc
			) b where dayno<=trunc(sysdate) and dayno>trunc(sysdate)-7]]>
	</select>
	
	<select id="memberGender"><!-- 전체 회원 기준 성별 구분 파이 차트 -->
		select count(*), to_number(substr(to_char(member_jumin2),1,1)) 성별구분
		 from member group by to_number(substr(to_char(member_jumin2),1,1))
	</select>
	
	<select id="newMemberGender"><!-- 최근 일주일 신규 회원 성별 구분 -->
		<![CDATA[select count(*), to_number(substr(to_char(member_jumin2),1,1)) 성별구분 
		from member where trunc(member_join_date) <= trunc(sysdate) and trunc(member_join_date) > trunc(sysdate)-7 
		group by to_number(substr(to_char(member_jumin2),1,1))]]>
	</select>
	
	<select id="memberAge"><!-- 전체 회원 기준 연령 구분 파이 차트 -->
		select count(*), to_number(substr(to_char(member_jumin1),1,1)) 연령구분 
		from member group by to_number(substr(to_char(member_jumin1),1,1))
	</select>
	
	<select id="newMemberAge"><!-- 최근 일주일 신규 회원 연령 구분 -->
		<![CDATA[select count(*), to_number(substr(to_char(member_jumin1),1,1)) 연령구분 
			from member where trunc(member_join_date) <= trunc(sysdate) and trunc(member_join_date) > trunc(sysdate)-7 
			group by to_number(substr(to_char(member_jumin1),1,1))]]>
	</select>
	
	<select id="memberRegion"><!-- 전체 회원 지역 구분 파이 차트 -->
		select count(*), substr(member_addr1,1,2) from member group by substr(member_addr1,1,2)
	</select>
	
	<select id="newMemberRegion"><!-- 최근 일주일 신규 회원 지역 구분 -->
		<![CDATA[select count(*), substr(member_addr1,1,2) from member 
		where trunc(member_join_date) <= trunc(sysdate) and trunc(member_join_date) > trunc(sysdate)-7 group by substr(member_addr1,1,2)]]>
	</select>
	
	<!-- //////////////////////////////////////// -->
	<!-- 카테고리 관리 기능 구현 시 카테고리 판매량 분석 추가. -->
	<!-- 기간 지정 가능하도록 구현하기. -->
	
	<select id="bookSelling"><!-- 전체 기간 기준 가장 많이 팔인 책 8권 -->
		<![CDATA[select a.* from (select book_category, book_name, book_sell_count 
		from book order by book_sell_count desc) a where rownum>=1 and rownum<=8]]>
	</select>
	
	<select id="monthBookSelling"><!-- 저번 달의 판매량 순위 -->
		<![CDATA[
			select c.* from (
  				select order_book_name, sum(order_book_count) sellCount from (
    				select a.order_trade_num, a.order_regdate, b.book_num, b.order_book_name, order_book_count 
    				from order_book a inner join order_detail b on a.ORDER_TRADE_NUM = b.ORDER_TRADE_NUM where a.order_use_yn = 1) 
 	 			where extract(month from order_regdate)=extract(month from sysdate)-1 group by order_book_name order by sellCount desc) c 
			where rownum>=1 and rownum<=8;
		]]>
	</select>
	
	<select id="weekBookSelling"><!-- 최근 7일 판매량 순위 -->
		<![CDATA[
			select c.* from (
  				select order_book_name, sum(order_book_count) sellCount from (
    				select a.order_trade_num, a.order_regdate, b.book_num, b.order_book_name, order_book_count 
    				from order_book a inner join order_detail b on a.ORDER_TRADE_NUM = b.ORDER_TRADE_NUM where a.order_use_yn = 1) 
  				where order_regdate<=trunc(sysdate) and order_regdate>trunc(sysdate)-7 group by order_book_name order by sellCount desc) c 
			where rownum>=1 and rownum<=8
		]]>
	</select>
	
	<!-- //////////////////////////////////////// -->
	<!-- 차트 구현 후 기간 지정 가능 종합 통계 구현하기 --><!-- 매출 분석 순이익 필요? 매출 분석 시 결제 상태와 배송 상태 고려 -->
	
	<select id="monthOrderNum"><!-- 달별 주문량 조회 -->
		<![CDATA[select count(*), extract(month from order_regdate) from order_book group by extract(month from order_regdate)]]>
	</select>
	
	<select id="monthSales"><!-- 달별 판매량 조회 -->
		select sum(ORDER_RECEIVE_MONEYSUM) sales,extract(month from order_regdate) month from order_book group by extract(month from order_regdate)
	</select>
	
	<select id="weekOrderNum"><!-- 최근 7일 날짜별 주문량 조회 -->
		<![CDATA[select count(*), trunc(order_regdate) day from order_book where trunc(order_regdate)<=trunc(sysdate) and trunc(order_regdate)>trunc(sysdate)-7
		group by trunc(order_regdate) order by day desc]]>
	</select>
	
	<select id="weekSales"><!-- 최근 7일 날짜별 판매량 -->
		<![CDATA[select sum(ORDER_RECEIVE_MONEYSUM) sales, trunc(order_regdate) day from order_book where trunc(order_regdate)<=trunc(sysdate) and trunc(order_regdate)>trunc(sysdate)-7
		group by trunc(order_regdate) order by day desc]]>
	</select>
	
	<select id="monthOrderGender">
		select count(*), to_number(substr(to_char(member_jumin2),1,1)) gender, extract(month from order_regdate) month from (
			select a.order_trade_num, a.order_regdate, a.member_id, b.member_jumin1, b.member_jumin2, b.member_addr1 
			from order_book a inner join member b on a.member_id=b.member_id)
		group by to_number(substr(to_char(member_jumin2),1,1)), extract(month from order_regdate) order by month
	</select>
	
	<select id="weekOrderGender"><!-- 최근 7일 주문 성별 통계 -->
		<![CDATA[
			select count(*), to_number(substr(to_char(member_jumin2),1,1)) 성별구분 from (
				select a.order_trade_num, a.order_regdate, a.member_id, b.member_jumin1, b.member_jumin2, b.member_addr1 
				from order_book a inner join member b on a.member_id=b.member_id where trunc(order_regdate) <= trunc(sysdate) and trunc(order_regdate) > trunc(sysdate)-7)
			group by to_number(substr(to_char(member_jumin2),1,1))
		]]>
	</select>
	
	<select id="monthOrderAge"><!-- 달별 연령 구분 -->
		select count(*), to_number(substr(to_char(member_jumin1),1,1)) age, extract(month from order_regdate) month from (
			select a.order_trade_num, a.order_regdate, a.member_id, b.member_jumin1, b.member_jumin2, b.member_addr1 
			from order_book a inner join member b on a.member_id=b.member_id)
		group by to_number(substr(to_char(member_jumin1),1,1)), extract(month from order_regdate) order by month
	</select>
	
	<select id="weekOrderAge"><!-- 최근 7일 주문 연령별 통계 -->
		<![CDATA[
			select count(*), to_number(substr(to_char(member_jumin1),1,1)) 연령구분 from (
				select a.order_trade_num, a.order_regdate, a.member_id, b.member_jumin1, b.member_jumin2, b.member_addr1 
				from order_book a inner join member b on a.member_id=b.member_id where trunc(order_regdate) <= trunc(sysdate) and trunc(order_regdate) > trunc(sysdate)-7)
			group by to_number(substr(to_char(member_jumin1),1,1))
		]]>
	</select>
	
	<select id="monthOrderRegion">
		select count(*), substr(member_addr1,1,2) region, extract(month from order_regdate) month from (
			select a.order_trade_num, a.order_regdate, a.member_id, b.member_jumin1, b.member_jumin2, b.member_addr1 
			from order_book a inner join member b on a.member_id=b.member_id)
		group by substr(member_addr1,1,2), extract(month from order_regdate) order by month
	</select>
	
	<select id="weekOrderRegion"><!-- 최근 7일 주문 지역별 통계 -->
		<![CDATA[
			select count(*), substr(member_addr1,1,2) 지역구분 from (
				select a.order_trade_num, a.order_regdate, a.member_id, b.member_jumin1, b.member_jumin2, b.member_addr1 
				from order_book a inner join member b on a.member_id=b.member_id where trunc(order_regdate) <= trunc(sysdate) and trunc(order_regdate) > trunc(sysdate)-7)
			group by substr(member_addr1,1,2)]]>
	</select>
	
</mapper>